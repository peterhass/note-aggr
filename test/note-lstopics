#!/usr/bin/env bash
source "$(dirname -- "${BASH_SOURCE[0]}")/../bin/env.sh"

log() { echo -e "\033[1m$@\033[0m" >&2; }
failure_log() { printf '\033[1;31m%s\033[0m\n' "$*" >&2; }
success_log() { printf '\033[1;32m%s\033[0m\n' "$*" >&2; }


llm_assert() {
  local user_input="$1"
  local assertion=$(cat -)

  local response=$(
    llm <<-EOF
    You are a quality assurance expert. When giving a prompt, you MUST respond with TRUE or FALSE depending if the given assertion is fulfilled or not.

    # Example
    Assertion: Hungry lions can fly.
    Response: FALSE

    # Assertion
    $assertion

    # User Input
    $topics
EOF
  )

  local trimmed_response=$(xargs <<< "$response")

  case "$trimmed_response" in
    "TRUE")
      success_log "[${FUNCNAME[1]}]" "Succeeded assertion"
      return 0
      ;;
    "FALSE")
      failure_log "[${FUNCNAME[1]}]" "Failed assertion for input '$user_input'"
      exit 1
      ;;
    *)
      failure_log "[${FUNCNAME[1]}]" "Failed assertion for input '$user_input'. Unrecognized LLM response: $trimmed_response"
      exit 1
      ;;
  esac
}

test_about_me() {
  log "[$FUNCNAME] Checking topic selection according to \$ABOUT_ME"

  export ABOUT_ME="
  Name: Peter
  Role: Scrum Master
  Company: FancyTravel GmbH.
  Focus Areas:
  - team building
  - team processes
  "
  topics=$(note-lstopics <<-EOF
  - morning standup: team mentions slow loading on itinerary pages, maybe caching issue? check logs later
  - call with devops: server response spikes around 11am, maybe DB indexing problem
  - marketing wants new promo banner for Canada winter trips up by Friday, check assets
  - got feedback from support: some users complaining checkout button disappears on mobile safari
  - looked at new analytics dashboard, bounce rate on landing page higher than last week
  - Marty complained about still waiting for others to review his PRs
EOF
  )

  llm_assert "$topics" <<-EOF
  The given user input mentions none of the following topics:
  - server response times
  - database indexing
  - support
  - analytics
EOF
}


test_about_me
